<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•Œë¦¼ - ìºì‹œë´‡</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            padding-bottom: 80px;
        }
        .container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        .header-content { 
            display: flex; 
            justify-content: space-between;
            align-items: center; 
        }
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }
        .page-title { 
            font-size: 22px; 
            font-weight: 700;
            flex: 1;
            text-align: center;
            margin-right: 40px;
        }
        .mark-all-read {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        }
        
        .notification-stats {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 5px;
        }
        
        .filter-tabs {
            display: flex;
            background: white;
            padding: 15px 20px;
            gap: 10px;
            overflow-x: auto;
            border-bottom: 1px solid #e9ecef;
        }
        .filter-tab {
            padding: 8px 16px;
            background: #f8f9fa;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }
        .filter-tab.active {
            background: #667eea;
            color: white;
        }
        
        .notifications-list {
            padding: 20px;
        }
        .notification-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .notification-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .notification-item.unread {
            border-left: 4px solid #667eea;
            background: #f8f9ff;
        }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .notification-type {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .type-icon {
            font-size: 24px;
        }
        .type-label {
            font-size: 14px;
            font-weight: 600;
            color: #2d3436;
        }
        .notification-time {
            font-size: 12px;
            color: #95a5a6;
        }
        .notification-message {
            color: #636e72;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .notification-reward {
            display: inline-block;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 700;
        }
        
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: #95a5a6; 
        }
        .empty-icon { 
            font-size: 64px; 
            margin-bottom: 15px; 
        }
        .empty-text {
            font-size: 16px;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 600px;
            width: 100%;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            color: #95a5a6;
            text-decoration: none;
            font-size: 12px;
        }
        .nav-item.active { color: #667eea; }
        .nav-icon { 
            font-size: 24px; 
            display: block; 
            margin-bottom: 5px; 
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="history.back()">â†</button>
                <div class="page-title">ì•Œë¦¼</div>
                <button class="mark-all-read" onclick="markAllAsRead()">ëª¨ë‘ ì½ìŒ</button>
            </div>
        </div>

        <div class="notification-stats">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">ì „ì²´ ì•Œë¦¼</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="unreadCount">0</div>
                    <div class="stat-label">ì½ì§€ ì•ŠìŒ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="todayCount">0</div>
                    <div class="stat-label">ì˜¤ëŠ˜ ë°›ì€ ì•Œë¦¼</div>
                </div>
            </div>
        </div>

        <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterNotifications('all', this)">ì „ì²´</button>
            <button class="filter-tab" onclick="filterNotifications('mission', this)">ğŸ¯ ë¯¸ì…˜</button>
            <button class="filter-tab" onclick="filterNotifications('attendance', this)">ğŸ“… ì¶œì„</button>
            <button class="filter-tab" onclick="filterNotifications('inquiry', this)">ğŸ’¬ ë¬¸ì˜</button>
            <button class="filter-tab" onclick="filterNotifications('reward', this)">ğŸ’° ë³´ìƒ</button>
            <button class="filter-tab" onclick="filterNotifications('admin', this)">ğŸ”” ê³µì§€</button>
        </div>

        <div class="notifications-list" id="notificationsList">
            <div class="loading">
                <div class="spinner"></div>
                <div>ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="index.html" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            í™ˆ
        </a>
        <a href="missions.html" class="nav-item">
            <span class="nav-icon">ğŸ¯</span>
            ë¯¸ì…˜
        </a>
        <a href="attendance.html" class="nav-item">
            <span class="nav-icon">ğŸ“…</span>
            ì¶œì„
        </a>
        <a href="me.html" class="nav-item">
            <span class="nav-icon">ğŸ’¤</span>
            ë§ˆì´
        </a>
    </div>

    <script>
        const SUPABASE_URL = 'https://apuiydnqimlmeqpftijl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwdWl5ZG5xaW1sbWVxcGZ0aWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MTgzMDAsImV4cCI6MjA4NTA5NDMwMH0.G7CvTQLEsIzkhJfsa67ou28Pbt8J5bkbEvyEgSRziXI';

        let allNotifications = [];
        let currentFilter = 'all';

        const typeConfig = {
            mission: { icon: 'ğŸ¯', label: 'ë¯¸ì…˜ ì™„ë£Œ', color: '#3498db' },
            attendance: { icon: 'ğŸ“…', label: 'ì¶œì„ ì²´í¬', color: '#9b59b6' },
            inquiry: { icon: 'ğŸ’¬', label: 'ë¬¸ì˜ ë‹µë³€', color: '#e67e22' },
            reward: { icon: 'ğŸ’°', label: 'ë³´ìƒ ì§€ê¸‰', color: '#27ae60' },
            admin: { icon: 'ğŸ””', label: 'ê³µì§€ì‚¬í•­', color: '#e74c3c' }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                location.href = 'login.html';
                return;
            }

            await loadNotifications();
        });

        async function loadNotifications() {
            const userId = localStorage.getItem('userId');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/notifications?user_id=eq.${userId}&order=created_at.desc`, {
                    headers: { 
                        'apikey': SUPABASE_KEY, 
                        'Authorization': `Bearer ${SUPABASE_KEY}` 
                    }
                });
                
                allNotifications = await response.json();
                console.log('ë¶ˆëŸ¬ì˜¨ ì•Œë¦¼ ê°œìˆ˜:', allNotifications.length);
                console.log('ì•Œë¦¼ ë°ì´í„°:', allNotifications);
                
                displayNotifications();
                updateStats();
            } catch (error) {
                console.error('ì•Œë¦¼ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('notificationsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âš ï¸</div>
                        <div class="empty-text">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>
                    </div>
                `;
            }
        }

        function displayNotifications() {
            const list = document.getElementById('notificationsList');
            
            let filteredNotifications = allNotifications;
            if (currentFilter !== 'all') {
                filteredNotifications = allNotifications.filter(n => n.type === currentFilter);
            }

            if (filteredNotifications.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ””</div>
                        <div class="empty-text">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                return;
            }

            list.innerHTML = filteredNotifications.map(notification => {
                const config = typeConfig[notification.type] || typeConfig.admin;
                const timeAgo = getTimeAgo(notification.created_at);
                const isUnread = !notification.is_read;

                return `
                    <div class="notification-item ${isUnread ? 'unread' : ''}" 
                         onclick="markAsRead(${notification.id})"
                         data-type="${notification.type}">
                        <div class="notification-header">
                            <div class="notification-type">
                                <span class="type-icon">${config.icon}</span>
                                <span class="type-label">${config.label}</span>
                            </div>
                            <div class="notification-time">${timeAgo}</div>
                        </div>
                        <div class="notification-message">${notification.message}</div>
                        ${notification.reward_amount ? `
                            <div class="notification-reward">+${notification.reward_amount.toLocaleString()}ì›</div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const totalCount = allNotifications.length;
            const unreadCount = allNotifications.filter(n => !n.is_read).length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayCount = allNotifications.filter(n => 
                n.created_at.split('T')[0] === today
            ).length;

            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('unreadCount').textContent = unreadCount;
            document.getElementById('todayCount').textContent = todayCount;
        }

        function filterNotifications(type, element) {
            currentFilter = type;
            
            // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            displayNotifications();
        }

        async function markAsRead(notificationId) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/notifications?id=eq.${notificationId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ is_read: true })
                });

                // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                const notification = allNotifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.is_read = true;
                }
                
                displayNotifications();
                updateStats();
            } catch (error) {
                console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            }
        }

        async function markAllAsRead() {
            if (!confirm('ëª¨ë“  ì•Œë¦¼ì„ ì½ìŒ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const userId = localStorage.getItem('userId');
            
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/notifications?user_id=eq.${userId}&is_read=eq.false`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ is_read: true })
                });

                // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                allNotifications.forEach(n => n.is_read = true);
                
                displayNotifications();
                updateStats();
                
                alert('ëª¨ë“  ì•Œë¦¼ì„ ì½ìŒ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ëª¨ë‘ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const diffInSeconds = Math.floor((now - past) / 1000);

            if (diffInSeconds < 60) return 'ë°©ê¸ˆ ì „';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}ë¶„ ì „`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}ì‹œê°„ ì „`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}ì¼ ì „`;
            
            return past.toLocaleDateString('ko-KR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
    </script>
</body>
</html>
