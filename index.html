<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="adpick-auth" content="ì—¬ê¸°ì—_ì• ë“œí”½_ì¸ì¦ì½”ë“œ">
    <title>cashdet | í™ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #0052D4; --gray: #888; }
        body { margin: 0; font-family: sans-serif; background: #fff; padding-bottom: 80px; }
        .header { padding: 20px; position: relative; }
        .logo { font-size: 28px; font-weight: 900; }
        .user-info { margin-top: 10px; cursor: pointer; }
        .cash-val { font-size: 36px; font-weight: 900; margin: 5px 0; }
        .noti-icon { position: absolute; top: 25px; right: 25px; font-size: 24px; cursor: pointer; }
        .noti-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: red; border-radius: 50%; display: none; }
        .banner { width: 90%; height: 160px; background: #ccc; margin: 15px auto; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; position: relative; }
        .banner-idx { position: absolute; bottom: 10px; right: 20px; font-size: 14px; }
        .mission-box { padding: 0 20px; }
        .ad-card { background: #888; padding: 20px; border-radius: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .ad-card.done { background: #eee; color: #aaa; cursor: default; }
        .nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: #f0f0f0; display: flex; justify-content: space-around; align-items: center; font-weight: bold; border-top: 1px solid #ddd; }
        .auth-overlay { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="auth-ui" class="auth-overlay hidden">
    <h1 style="color:var(--primary)">cashdet</h1>
    <p>ë³´ìƒí˜• ì¬í…Œí¬ì˜ ì‹œì‘</p>
    <input type="email" id="email" placeholder="ì´ë©”ì¼" style="width:100%; padding:12px; margin-bottom:10px;">
    <input type="password" id="pw" placeholder="ë¹„ë°€ë²ˆí˜¸" style="width:100%; padding:12px; margin-bottom:10px;">
    <button onclick="handleLogin()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px;">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</button>
</div>

<div class="header">
    <div class="logo">cashdet</div>
    <div class="noti-icon" onclick="location.href='me.html'">ğŸ””<div id="dot" class="noti-dot"></div></div>
    <div class="user-info" onclick="location.href='me.html'"><span id="nick">ë‹‰ë„¤ì„</span> ë‹˜ì˜ ë³´ìœ  ìºì‹œ ></div>
    <div class="cash-val" id="cash">0 c</div>
</div>

<div class="banner" id="top-banner">ì‚¬ì§„ ë°°ë„ˆ <span class="banner-idx">1/2</span></div>

<div class="mission-box">
    <h3>ë¯¸ì…˜</h3>
    <div id="ad-list"></div>
    
    <div style="margin:20px 0; border-radius:15px; overflow:hidden;">
        <iframe src="https://adpick.co.kr/nativeAD/ad.php?bannerType=type1&limit=1&affid=e1f79a&frameId=AdpickAdFrame_2026127%40234910&popup=false" width="100%" frameborder="0" scrolling="no" data-adpick_nativeAD id="AdpickAdFrame_2026127@234910" referrerpolicy="unsafe-url"></iframe>
    </div>
    
    <button style="width:100%; padding:15px; border-radius:15px; border:none; background:#888; font-weight:bold;">ë¯¸ì…˜ ì „ì²´ ë³´ê¸°</button>
</div>

<div class="nav">
    <div onclick="location.href='index.html'">í™ˆ</div>
    <div>ë¯¸ì…˜</div>
    <div>ì¿ í°</div>
    <div>êµ¬ë§¤</div>
    <div onclick="location.href='me.html'">ë‚˜ì˜ ì •ë³´</div>
</div>

<script>
    const client = supabase.createClient('URL', 'KEY');

    async function checkAuth() {
        const { data: { session } } = await client.auth.getSession();
        if (!session) {
            document.getElementById('auth-ui').classList.remove('hidden');
        } else {
            loadData(session.user);
        }
    }

    async function loadData(user) {
        // í”„ë¡œí•„ ë° ìºì‹œ ë¡œë“œ
        let { data: profile } = await client.from('profiles').select('*').eq('id', user.id).single();
        document.getElementById('nick').innerText = profile.nickname || 'íšŒì›';
        document.getElementById('cash').innerText = profile.cash.toLocaleString() + ' c';

        // ì•Œë¦¼ ì²´í¬
        const { count } = await client.from('logs').select('*', { count: 'exact' }).eq('user_id', user.id).eq('is_read', false);
        if(count > 0) document.getElementById('dot').style.display = 'block';

        // ê´‘ê³  ë¦¬ìŠ¤íŠ¸ (ìµœì‹ ìˆœ)
        const { data: ads } = await client.from('ads').select('*').order('created_at', { ascending: false });
        const { data: myLogs } = await client.from('logs').select('ad_id').eq('user_id', user.id);
        const doneAds = myLogs.map(l => l.ad_id);

        const list = document.getElementById('ad-list');
        ads.forEach(ad => {
            const isDone = doneAds.includes(ad.id);
            const div = document.createElement('div');
            div.className = `ad-card ${isDone ? 'done' : ''}`;
            div.innerHTML = `<div>${isDone ? '[ì™„ë£Œ] ' : ''}${ad.title}</div><div>${ad.reward_cash}c</div>`;
            if(!isDone) div.onclick = () => startMission(ad, user.id);
            list.appendChild(div);
        });
    }

    function startMission(ad, uid) {
        if(confirm("ê´‘ê³  ì‚¬ì´íŠ¸ì— 10ì´ˆ ì´ìƒ ë¨¸ë¬¼ëŸ¬ì•¼ í•©ë‹ˆë‹¤.\n10ì´ˆ ì „ì— ë‚˜ê°€ë©´ í¬ì¸íŠ¸ê°€ íšŒìˆ˜ë©ë‹ˆë‹¤.\n24ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¤‘")) {
            window.open(ad.link_url, '_blank');
            setTimeout(async () => {
                const { error } = await client.rpc('add_cash', { user_id: uid, amount: ad.reward_cash, ad_id: ad.id, msg: ad.title + ' ì ë¦½' });
                if(!error) { alert("ì ë¦½ ì™„ë£Œ!"); location.reload(); }
            }, 10000);
        }
    }

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('pw').value;
        const { data, error } = await client.auth.signInWithPassword({ email, password });
        if(error) {
            // íšŒì›ê°€ì… ì‹œë„
            const { error: signUpErr } = await client.auth.signUp({ email, password });
            if(signUpErr) alert(signUpErr.message);
            else alert("ê°€ì… í™•ì¸ ë©”ì¼ì„ í™•ì¸í•˜ì„¸ìš”!");
        } else location.reload();
    }

    checkAuth();
</script>
</body>
</html>
